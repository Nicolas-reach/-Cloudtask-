<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudTask ☁️</title>
    <style>
        /* Estilos básicos para ficar bonito */
        body { font-family: 'Segoe UI', sans-serif; max-width: 600px; margin: 2rem auto; background: #1a1a1a; color: #e0e0e0; }
        h1 { text-align: center; color: #4CAF50; margin-bottom: 2rem; }
        
        /* Área de adicionar */
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        input { flex: 1; padding: 12px; border-radius: 6px; border: 1px solid #333; background: #2d2d2d; color: white; outline: none; }
        input:focus { border-color: #4CAF50; }
        button.add-btn { padding: 12px 25px; background: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        button.add-btn:hover { background: #45a049; }

        /* Lista de tarefas */
        ul { list-style: none; padding: 0; }
        li { background: #2d2d2d; margin: 10px 0; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #4CAF50; transition: transform 0.2s; }
        li:hover { transform: translateX(5px); }
        
        /* Botão de excluir */
        .delete-btn { background: #ff4444; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; margin-left: 10px; }
        .delete-btn:hover { background: #cc0000; }
        
        small { color: #888; font-size: 0.8em; margin-right: 10px; }
    </style>
</head>
<body>
    
    <div id="login-container" style="max-width: 400px; margin: 50px auto; text-align: center; font-family: Arial, sans-serif;">
        <h2>Entrar no CloudTask</h2>
        <input type="email" id="emailInput" placeholder="Seu e-mail" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;">
        <input type="password" id="senhaInput" placeholder="Sua senha" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;">
        <button onclick="fazerLogin()" style="width: 100%; padding: 10px; background-color: #0073b1; color: white; border: none; border-radius: 4px; cursor: pointer;">Entrar</button>
    </div>

    <div id="app-container" style="display: none;">
        <button onclick="sair()" style="float: right; padding: 5px 10px; background-color: #dc3545; color: white; border: none; cursor: pointer; border-radius: 4px;">Sair</button>
        
        <h1>CloudTask ☁️</h1>

        <div class="input-group">
            <input type="text" id="taskInput" placeholder="O que você precisa fazer?">
            <button class="add-btn" onclick="adicionarTarefa()">Adicionar</button>
        </div>

        <ul id="listaTarefas">
            </ul>
    </div>

    <script>
        const API_URL = 'https://cloudtask-api-u0aa.onrender.com';

        // --- 1. FUNÇÃO DE LOGIN ---
        async function fazerLogin() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('senhaInput').value;

            try {
                const resposta = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const dados = await resposta.json();

                if (resposta.ok) {
                    // Salva o Token no navegador
                    localStorage.setItem('tokenCloudTask', dados.token);
                    
                    // Esconde Login e mostra App
                    document.getElementById('login-container').style.display = 'none';
                    document.getElementById('app-container').style.display = 'block';
                    
                    // Carrega as tarefas!
                    carregarTarefas(); 
                } else {
                    alert("Erro no login: " + dados.error);
                }
            } catch (erro) {
                alert("Erro ao conectar com o servidor.");
            }
        }

        // --- 2. FUNÇÃO DE SAIR (LOGOUT) ---
        function sair() {
            localStorage.removeItem('tokenCloudTask'); // Tira o crachá
            document.getElementById('login-container').style.display = 'block'; // Mostra login
            document.getElementById('app-container').style.display = 'none'; // Esconde app
        }

       // --- 3. CARREGAR TAREFAS (GET) - COM O CRACHÁ! ---
async function carregarTarefas() {
    const token = localStorage.getItem('tokenCloudTask');
    if (!token) return; // Segurança extra

    try {
        const resposta = await fetch(`${API_URL}/tasks`, {
            headers: { 'Authorization': 'Bearer ' + token } // <--- O CRACHÁ AQUI!
        });
        
        // Se o token for inválido, desloga
        if (resposta.status === 401 || resposta.status === 403) {
            sair();
            return;
        }

        // CORREÇÃO 1: Usar 'resposta' em vez de 'response'
        const dados = await resposta.json();

        // CORREÇÃO 2: DynamoDB devolve os dados dentro de 'Items'. 
        // Essa linha garante que 'tarefas' seja sempre um array.
        const tarefas = Array.isArray(dados) ? dados : (dados.Items || []);

        const lista = document.getElementById('listaTarefas');
        lista.innerHTML = ''; // Limpa antes de preencher

        tarefas.forEach(tarefa => {
            const item = document.createElement('li');
            
            const riscado = tarefa.completed ? 'text-decoration: line-through; color: #888;' : '';
            const checkado = tarefa.completed ? 'checked' : '';

            item.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" ${checkado} onchange="atualizarStatus('${tarefa.id}', this.checked)">
                    <span style="${riscado}">${tarefa.title}</span>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <button class="delete-btn" onclick="deletarTarefa('${tarefa.id}')">X</button>
                </div>
            `;
            lista.appendChild(item);
        });
    } catch (erro) {
        console.error("Erro ao carregar:", erro);
    }
}
        // --- 4. ADICIONAR TAREFA (COM RASTREADOR) ---
        async function adicionarTarefa() {
            console.log("Passo 1: Botão clicado!");
            
            const input = document.getElementById('taskInput'); 
            if (!input.value) {
                console.log("Erro: O campo de texto está vazio.");
                return; 
            }

            const token = localStorage.getItem('tokenCloudTask');
            console.log("Passo 2: Pegou o token no bolso.", token ? "Token existe" : "Sem token!");

            try {
                console.log("Passo 3: Enviando dados para o servidor...");
                const resposta = await fetch(`${API_URL}/tasks`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token 
                    },
                    body: JSON.stringify({ 
                        id: Date.now().toString(),
                        title: input.value, 
                        completed: false 
                    })
                });

                console.log("Passo 4: Servidor respondeu com status:", resposta.status);

                if (resposta.ok) {
                    console.log("Passo 5: Sucesso! Limpando campo e recarregando lista.");
                    input.value = ''; 
                    carregarTarefas(); 
                } else {
                    const dadosErro = await resposta.json();
                    console.error("Passo 5 (Erro): O backend recusou a tarefa.", dadosErro);
                    alert("O servidor recusou. Motivo: " + JSON.stringify(dadosErro));
                }
            } catch (erro) {
                console.error("Erro Fatal no Frontend:", erro);
                alert("O navegador não conseguiu falar com o servidor!");
            }
        }
        
        // --- 5. DELETAR TAREFA (DELETE) ---
        async function deletarTarefa(id) {
            if (!confirm("Tem certeza que quer excluir?")) return;
            const token = localStorage.getItem('tokenCloudTask');

            try {
                const resposta = await fetch(`${API_URL}/tasks/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (resposta.ok) {
                    carregarTarefas(); 
                } else {
                    alert("Erro: Você não tem permissão para apagar isso ou o servidor falhou.");
                }
            } catch (erro) {
                console.error("Erro ao excluir:", erro);
            }
        }

        // --- 6. ATUALIZAR STATUS (PUT) - Marcar como feita/não feita ---
        async function atualizarStatus(id, status) {
    const token = localStorage.getItem('tokenCloudTask');
    if (!token) return;

    try {
        // CORREÇÃO: Adicionamos '/tasks/' antes do ID na URL
        const resposta = await fetch(`${API_URL}/tasks/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            },
            // Enviamos o status (true ou false) que vem do checkbox
            body: JSON.stringify({ completed: status })
        });

        if (resposta.ok) {
            console.log("Status atualizado com sucesso!");
            carregarTarefas(); // Recarrega a lista para mostrar o riscado
        } else {
            console.error("Erro ao atualizar no servidor");
        }
    } catch (erro) {
        console.error("Erro ao atualizar:", erro);
        alert("Erro ao mudar status!");
    }
}
    </script>
</body>
</html>